@using HomeEstate.Data.Models.Enum
@model AddAndUpdatePropertyViewModel

@{
    ViewData["Title"] = Model.Title;
}
<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="~/css/addPage.css" asp-append-version="true" />
    <title>Управление на имоти</title>
</head>
<body>
    <div class="form-container">

        <div class="form-header">
            <h1 class="form-title" id="formTitle">Add Property</h1>
            <p class="form-subtitle">Fill all the required fields</p>
        </div>
        <form id="propertyForm" asp-controller="Property" asp-action="Add" method="POST" enctype="multipart/form-data">
            <input type="hidden" id="propertyId" asp-for="Id" />

            <div class="form-group">
                <label class="form-label" for="title">
                    Tittle <span class="required">*</span>
                </label>
                <input type="text" id="title" name="title" asp-for="Title" class="form-input" required
                       placeholder="For example: Luxury apartment in the center">
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="form-label" for="description">
                    Description <span class="required">*</span>
                </label>
                <textarea id="description" name="description" asp-for="Description" class="form-textarea" required
                          placeholder="Describe your property in detail.."></textarea>
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label class="form-label">
                    Property type <span class="required">*</span>
                </label>
                <div class="type-selection">
                    <div class="type-option">
                        <input type="radio" id="sale" name="listingType" asp-for="ListingType" value="1" required>
                        <label for="sale" class="type-label">Sale</label>
                    </div>
                    <div class="type-option">
                        <input type="radio" id="rent" name="listingType" asp-for="ListingType" value="2">
                        <label for="rent" class="type-label">Rent</label>
                    </div>
                    <div class="type-option">
                        <input type="radio" id="both" name="listingType" asp-for="ListingType" value="3">
                        <label for="both" class="type-label">Both</label>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" id="priceField">
                    <label class="form-label" for="price">
                        Price (lv.) <span class="required">*</span>
                    </label>
                    <input type="number" id="price" name="price" asp-for="Price" class="form-input" required
                           placeholder="150000" min="0">
                    <span asp-validation-for="Price" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label class="form-label" for="area">
                       Area (sq/m) <span class="required">*</span>
                    </label>
                    <input type="number" id="area" name="area" asp-for="Area" class="form-input" required
                           placeholder="85" min="1">
                    <span asp-validation-for="Area" class="text-danger"></span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label" for="locationId">
                        Location <span class="required">*</span>
                    </label>
                    <select id="locationId" name="locationId" asp-for="LocationId" asp-items="Model.Locations" class="form-select" required>
                        <option value="">Choose location</option>
                    </select>
                    <span asp-validation-for="LocationId" class="text-danger"></span>
                </div>
                <div class="form-group">
                    <label class="form-label" for="categoryId">
                        Category <span class="required">*</span>
                    </label>
                    <select id="categoryId" name="categoryId" asp-for="CategoryId" class="form-select" required>
                        <option value="">Choose category</option>
                        <option value="1">Apartment</option>
                        <option value="2">House</option>
                        <option value="3">Office</option>
                        <option value="4">Villa</option>
                    </select>
                    <span asp-validation-for="CategoryId" class="text-danger"></span>
                </div>
            </div>

            <!-- Полета за наем  -->
            <div id="rentalFields" style="display: none;">
                <div class="form-row-three">
                    <div class="form-group">
                        <label class="form-label" for="monthlyRent">
                            Monthly rent (lv.) <span class="required rent-required" style="display: none;">*</span>
                        </label>
                        <input type="number" id="monthlyRent" asp-for="MonthlyRent" class="form-input"
                               placeholder="1200" min="0">
                        <span asp-validation-for="MonthlyRent" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="securityDeposit">
                            Deposit (lv.)
                        </label>
                        <input type="number" id="securityDeposit" asp-for="SecurityDeposit" class="form-input"
                               placeholder="2400" min="0">
                        <span asp-validation-for="SecurityDeposit" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="minimumLeasePeriod">
                            Minimum Lease Period
                        </label>
                        <input type="number" id="minimumLeasePeriod" asp-for="MinimumLeasePeriod" class="form-input"
                               placeholder="12" min="1" max="60">
                        <span asp-validation-for="MinimumLeasePeriod" class="text-danger"></span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="availableFrom">
                        Available From:
                    </label>
                    <input type="date" id="availableFrom" asp-for="AvailableFrom" class="form-input">
                    <span asp-validation-for="AvailableFrom" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label class="form-label">Additional rent features</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="petsAllowed" asp-for="PetsAllowed" value="true">
                            <label for="petsAllowed">Pets allowed</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="isFurnished" asp-for="IsFurnished" value="true">
                            <label for="isFurnished">Furnished</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="isParking" asp-for="IsParking" value="true">
                            <label for="isParking">Parking space</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">
                    Property type <span class="required">*</span>
                </label>
                <div class="type-selection">
                    <div class="type-option">
                        <input type="radio" id="oneBedroom" asp-for="PropertyType" value="1" required>
                        <label for="oneBedroom" class="type-label">One room</label>
                    </div>
                    <div class="type-option">
                        <input type="radio" id="twoBedrooms" asp-for="PropertyType" value="2">
                        <label for="twoBedrooms" class="type-label">Two rooms</label>
                    </div>
                    <div class="type-option">
                        <input type="radio" id="threeBedrooms" asp-for="PropertyType" value="3">
                        <label for="threeBedrooms" class="type-label">Three rooms</label>
                    </div>
                    <div class="type-option">
                        <input type="radio" id="multipleBedrooms" asp-for="PropertyType" value="4">
                        <label for="multipleBedrooms" class="type-label">Multiple rooms</label>
                    </div>
                </div>
                <span asp-validation-for="PropertyType" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label class="form-label" for="images">
                    Upload photos
                </label>
                <div class="file-upload" id="fileUploadArea">
                    <input type="file" id="images" name="images" asp-for="Images" multiple accept="image/*">
                    <div class="file-upload-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span id="uploadText">Choose photos or drag them here</span>
                        <small style="display: block; margin-top: 10px; color: #666;">
                            Maximum of 10 photos, up to 5MB each
                        </small>
                    </div>
                </div>
                <div id="imagePreview" class="image-preview"></div>
                <span asp-validation-for="Images" class="text-danger"></span>
            </div>

            <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Create property
                </button>
            </div>
        </form>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
</body>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const priceField = document.getElementById('priceField');
            const rentalFields = document.getElementById('rentalFields');
            const priceInput = document.getElementById('price');
            const monthlyRentInput = document.getElementById('monthlyRent');
            const saleRadio = document.getElementById('sale');
            const rentRadio = document.getElementById('rent');
            const bothRadio = document.getElementById('both');
            const imagePreview = document.getElementById('imagePreview');
            const fileInput = document.getElementById('images');
            const uploadText = document.getElementById('uploadText');
            fileInput.addEventListener('change', function (e) {
                const files = Array.from(e.target.files);
                if (validateFiles(files)) {
                    selectedFiles = [...selectedFiles, ...files];
                    updateFileList();
                    updateFileDisplay();
                }
            });
            let selectedFiles = [];

            function validateFiles(files) {
                const maxSize = 5 * 1024 * 1024; // 5MB
                const maxFiles = 10;
                const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

                if (selectedFiles.length + files.length > maxFiles) {
                    alert(`Можете да качите максимум ${maxFiles} снимки.`);
                    return false;
                }

                for (let file of files) {
                    if (file.size > maxSize) {
                        alert(`Файлът "${file.name}" е твърде голям. Максимален размер: 5MB`);
                        return false;
                    }
                    if (!allowedTypes.includes(file.type.toLowerCase())) {
                        alert(`Файлът "${file.name}" не е поддържан. Разрешени формати: JPG, PNG, GIF, WebP`);
                        return false;
                    }
                }
                return true;
            }

            function updateFileDisplay() {
                if (selectedFiles.length > 0) {
                    uploadText.innerHTML = `<i class="fas fa-check"></i> Избрани ${selectedFiles.length} файла`;
                    uploadText.style.color = '#28a745';
                    displayImagePreviews();
                } else {
                    uploadText.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Изберете снимки или ги плъзнете тук';
                    uploadText.style.color = '';
                    imagePreview.innerHTML = '';
                }
            }

            function displayImagePreviews() {
                imagePreview.innerHTML = '';
                selectedFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        previewItem.innerHTML = `
                                    <img src="${e.target.result}" alt="Preview ${index + 1}">
                                    <button type="button" class="remove-image" onclick="removeImage(${index})">
                                        <i class="fas fa-times"></i>
                                    </button>
                                `;
                        imagePreview.appendChild(previewItem);
                    };
                    reader.readAsDataURL(file);
                });
            }

            window.removeImage = function (index) {
                selectedFiles.splice(index, 1);
                updateFileList();
                updateFileDisplay();
            };

            function updateFileList() {
                const dt = new DataTransfer();
                selectedFiles.forEach(file => dt.items.add(file));
                fileInput.files = dt.files;
            }

            // Function to toggle fields based on listing type
            function toggleFields() {
                if (saleRadio.checked) {
                    // Продажба - показва цена, скрива наем
                    priceField.style.display = 'block';
                    rentalFields.style.display = 'none';
                    priceInput.required = true;
                    monthlyRentInput.required = false;

                    // Show price required asterisk, hide rent required
                    document.querySelector('.rent-required').style.display = 'none';

                } else if (rentRadio.checked) {
                    // Наем - скрива цена, показва наем
                    priceField.style.display = 'none';
                    rentalFields.style.display = 'block';
                    priceInput.required = false;
                    monthlyRentInput.required = true;

                    // Show rent required asterisk
                    document.querySelector('.rent-required').style.display = 'inline';

                } else if (bothRadio.checked) {
                    // И двете - показва всичко
                    priceField.style.display = 'block';
                    rentalFields.style.display = 'block';
                    priceInput.required = true;
                    monthlyRentInput.required = true;

                    // Show rent required asterisk
                    document.querySelector('.rent-required').style.display = 'inline';
                }
            }

            // Event listeners for listing type changes
            document.querySelectorAll('input[name="listingType"]').forEach(radio => {
                radio.addEventListener('change', toggleFields);
            });

            // File upload feedback
            // const fileInput = document.querySelector('input[type="file"]');
            const fileLabel = document.querySelector('.file-upload-label');

            if (fileInput && fileLabel) {
                fileInput.addEventListener('change', function (e) {
                    const files = e.target.files;
                    if (files.length > 0) {
                        fileLabel.innerHTML = `<i class="fas fa-check"></i> Избрани ${files.length} файла`;
                        fileLabel.style.color = '#28a745';
                    } else {
                        fileLabel.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Изберете снимки или ги плъзнете тук';
                        fileLabel.style.color = '';
                    }
                });
            }

            // Form validation before submit
            document.getElementById('propertyForm').addEventListener('submit', function (e) {
                const listingType = document.querySelector('input[name="listingType"]:checked');

                if (!listingType) {
                    e.preventDefault();
                    alert('Моля изберете вид обява!');
                    return false;
                }

                // Validate based on listing type
                if (listingType.value === '1') { // Sale
                    if (!priceInput.value || priceInput.value <= 0) {
                        e.preventDefault();
                        alert('Моля въведете валидна цена за продажба!');
                        priceInput.focus();
                        return false;
                    }
                } else if (listingType.value === '2') { // Rent
                    if (!monthlyRentInput.value || monthlyRentInput.value <= 0) {
                        e.preventDefault();
                        alert('Моля въведете валиден месечен наем!');
                        monthlyRentInput.focus();
                        return false;
                    }
                } else if (listingType.value === '3') { // Both
                    if (!priceInput.value || priceInput.value <= 0) {
                        e.preventDefault();
                        alert('Моля въведете валидна цена за продажба!');
                        priceInput.focus();
                        return false;
                    }
                    if (!monthlyRentInput.value || monthlyRentInput.value <= 0) {
                        e.preventDefault();
                        alert('Моля въведете валиден месечен наем!');
                        monthlyRentInput.focus();
                        return false;
                    }
                }
            });

            // Initialize fields display on page load
            toggleFields();
        });

        // Reset form function
        function resetForm() {
            document.getElementById('propertyForm').reset();
            document.getElementById('priceField').style.display = 'block';
            document.getElementById('rentalFields').style.display = 'none';

            const fileLabel = document.querySelector('.file-upload-label');
            if (fileLabel) {
                fileLabel.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Изберете снимки или ги плъзнете тук';
                fileLabel.style.color = '';
            }
        }
    </script>
}
